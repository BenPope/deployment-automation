apiVersion: apps/v1
kind: StatefulSet
metadata:
  name: {{ template "redpanda.name" . }}
spec:
  selector:
    matchLabels:
      app: {{ template "redpanda.name" . }}
  serviceName: {{ template "redpanda.name" . }}
  replicas: {{ .Values.replicaCount }}
  template:
    metadata:
      labels:
        app: {{ template "redpanda.name" . }} 
    spec:
      initContainers:
        - name: {{ template "redpanda.name" . }}-configurator
          image: {{ .Values.image.repository }}
          command: ["/bin/sh", "-c"]
          args:
            - >
              CONFIG=/tmp/config/redpanda.yaml;
              NODE_ID=${HOSTNAME##*-};
              SERVICE_NAME={{ template "redpanda.name" . }}-$NODE_ID;
              cp /tmp/base-config/redpanda.yaml $CONFIG;
              rpk --config $CONFIG config set redpanda.node_id $NODE_ID;
              if [ "$NODE_ID" = "0" ]; then
                rpk --config $CONFIG config set redpanda.seed_servers '[]' --format yaml;
              fi;
              rpk --config $CONFIG config set redpanda.advertised_rpc_api.address $SERVICE_NAME;
              rpk --config $CONFIG config set redpanda.advertised_rpc_api.port {{ .Values.config.redpanda.advertised_rpc_api.port }};
              rpk --config $CONFIG config set redpanda.advertised_kafka_api.address $SERVICE_NAME;
              rpk --config $CONFIG config set redpanda.advertised_kafka_api.port {{ .Values.config.redpanda.advertised_kafka_api.port }};
              rpk --config $CONFIG config set rpk.smp {{ .Values.config.rpk.smp }};
          volumeMounts:
            - name: {{ .Values.volumeMount.base.name }}
              mountPath: {{ .Values.volumeMount.base.mountPath }}
            - name: {{ .Values.volumeMount.name }}
              mountPath: {{ .Values.volumeMount.mountPath }}
      containers:
        - name: {{ template "redpanda.name" . }}
          image: {{ .Values.image.repository }}
          # command: ["/bin/sh", "-c"]
          args:
           - --config /tmp/config/redpanda.yaml
           - start
           - --
           - --default-log-level={{ .Values.config.seastar.default-log-level }}
          ports:
            - containerPort: {{ .Values.config.redpanda.admin.port }}
              name: admin
            - containerPort: {{ .Values.config.redpanda.advertised_kafka_api.port }}
              name: kafka
            - containerPort: {{ .Values.config.redpanda.advertised_rpc_api.port }}
              name: rpc
          volumeMounts:
            - name: {{ .Values.volumeMount.name }}
              mountPath: {{ .Values.volumeMount.mountPath }}
          resources:
            {{- toYaml .Values.resources | nindent 12 }}
      volumes:
        - name: {{ .Values.volumeMount.base.name }}
          configMap:
            name: {{ .Values.volumeMount.base.name }}
        - name: {{ .Values.volumeMount.name }}
          emptyDir: {}
